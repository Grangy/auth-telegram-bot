<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Authorization</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0088cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Telegram Auth">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1e1b4b 50%, var(--bg-primary) 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .phone-input {
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid rgba(148, 163, 184, 0.3);
            transition: all 0.3s ease;
        }
        
        .phone-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(30, 41, 59, 0.8);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
            border-color: rgba(148, 163, 184, 0.5);
        }
        
        .status-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .status-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        
        .status-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-slideIn {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="glass-card rounded-3xl p-8 w-full max-w-md mx-auto animate-fadeIn">
        <!-- Logo -->
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">üîê</div>
            <h1 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                Telegram Authorization
            </h1>
            <p class="text-gray-400">–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</p>
        </div>
        
        <!-- Auth Form -->
        <div id="authForm" class="space-y-6">
            <div>
                <label class="block text-lg font-semibold text-white mb-4">üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                
                <!-- –ö—Ä–∞—Å–∏–≤—ã–π input –¥–ª—è –Ω–æ–º–µ—Ä–∞ —Å –º–∞—Å–∫–æ–π -->
                <div class="relative">
                    <input 
                        type="tel" 
                        id="phoneInput" 
                        placeholder="+7 (___) ___-__-__"
                        class="phone-input w-full px-6 py-4 text-lg rounded-2xl text-white placeholder-gray-400 focus:outline-none"
                        maxlength="20"
                        autocomplete="tel"
                        inputmode="tel"
                        pattern="^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$"
                        title="–§–æ—Ä–º–∞—Ç: +7 (999) 123-45-67"
                    >
                    <button 
                        id="clearPhoneBtn" 
                        type="button" 
                        class="absolute inset-y-0 right-2 my-auto rounded-lg px-2 text-sm text-gray-400 hover:bg-gray-600/30 hover:text-white transition-all duration-200"
                        title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ"
                    >
                        ‚úï
                    </button>
                </div>
                
                <p class="text-xs text-gray-400 mt-2">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ª—é–±—ã–µ –∏–∑: <code>+7 (999) 123-45-67</code>, <code>8 999 123 45 67</code>, <code>79991234567</code>.
                    –í–≤–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫ —Ñ–æ—Ä–º–∞—Ç—É <strong>+7 (___) ___-__-__</strong>.
                </p>
                
                <p class="text-xs text-gray-500 mt-1">
                    –ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Ä–∞–∑—É <code>89991234567</code> –∏–ª–∏ <code>79991234567</code> ‚Äî —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                </p>
            </div>
            
            <button 
                id="requestAuthBtn" 
                class="btn-primary w-full py-4 px-6 rounded-2xl text-white font-semibold text-lg"
            >
                üöÄ –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
            </button>
        </div>
        
        <!-- Code Form -->
        <div id="codeForm" class="space-y-6 hidden">
            <div>
                <label class="block text-lg font-semibold text-white mb-4">üî¢ –ö–æ–¥ –∏–∑ Telegram</label>
                <input 
                    type="text" 
                    id="codeInput" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥"
                    class="phone-input w-full px-6 py-4 text-lg rounded-2xl text-white placeholder-gray-400 focus:outline-none text-center"
                    maxlength="6"
                >
            </div>
            
            <button 
                id="verifyCodeBtn" 
                class="btn-primary w-full py-4 px-6 rounded-2xl text-white font-semibold text-lg"
            >
                ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥
            </button>
            
            <button 
                id="backBtn" 
                class="btn-secondary w-full py-3 px-6 rounded-2xl text-white font-medium"
            >
                ‚Üê –ù–∞–∑–∞–¥
            </button>
        </div>
        
        <!-- User Info -->
        <div id="userInfo" class="space-y-6 hidden">
            <div class="text-center">
                <div class="text-4xl mb-4">üë§</div>
                <h2 class="text-2xl font-bold text-white mb-2" id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                <p class="text-gray-400" id="userPhone">+7 999 123 45 67</p>
            </div>
            
            <button 
                id="logoutBtn" 
                class="btn-secondary w-full py-3 px-6 rounded-2xl text-white font-medium"
            >
                üö™ –í—ã–π—Ç–∏
            </button>
        </div>
        
        <!-- Status -->
        <div id="status" class="mt-6 p-4 rounded-2xl text-center hidden"></div>
    </div>
    
    <!-- QR Code Modal -->
    <div id="qrModal" class="fixed inset-0 modal flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-3xl p-8 max-w-md mx-auto">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-white mb-4">üì± QR-–∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                <div id="qrCode" class="mb-4"></div>
                <p class="text-gray-400 mb-4">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ Telegram</p>
                <div class="space-y-3">
                    <button id="openTelegramBtn" class="btn-primary w-full px-6 py-3 rounded-xl text-white">
                        üöÄ –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                    </button>
                    <button id="closeQrBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auth Link Modal -->
    <div id="linkModal" class="fixed inset-0 modal flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-3xl p-8 max-w-md mx-auto">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-white mb-4">üîó –°—Å—ã–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                <div class="bg-slate-800/50 p-4 rounded-xl mb-4">
                    <p class="text-blue-400 break-all" id="authLink">https://t.me/bot?start=code</p>
                </div>
                <p class="text-gray-400 mb-4">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤ Telegram</p>
                <div class="space-y-3">
                    <button id="openTelegramFromLinkBtn" class="btn-primary w-full px-6 py-3 rounded-xl text-white">
                        üöÄ –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                    </button>
                    <button id="copyLinkBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                    </button>
                    <button id="closeLinkBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        
        // DOM elements
        const authForm = document.getElementById('authForm');
        const codeForm = document.getElementById('codeForm');
        const userInfo = document.getElementById('userInfo');
        const phoneInput = document.getElementById('phoneInput');
        const codeInput = document.getElementById('codeInput');
        const requestAuthBtn = document.getElementById('requestAuthBtn');
        const verifyCodeBtn = document.getElementById('verifyCodeBtn');
        const backBtn = document.getElementById('backBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const status = document.getElementById('status');
        const qrModal = document.getElementById('qrModal');
        const linkModal = document.getElementById('linkModal');
        const qrCode = document.getElementById('qrCode');
        const authLink = document.getElementById('authLink');
        const closeQrBtn = document.getElementById('closeQrBtn');
        const closeLinkBtn = document.getElementById('closeLinkBtn');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const openTelegramBtn = document.getElementById('openTelegramBtn');
        const openTelegramFromLinkBtn = document.getElementById('openTelegramFromLinkBtn');
        
        // Store current auth link
        let currentAuthLink = '';
        
        // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å –∂–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        class PhoneMaskHandler {
            constructor() {
                this.lastLength = 0;
            }

            // –£—Ç–∏–ª–∏—Ç—ã
            onlyDigits = (s) => (s || "").replace(/\D/g, "");
            clamp = (n, min, max) => Math.max(min, Math.min(max, n));

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–±–æ—Ä —Ü–∏—Ñ—Ä –∫ —Ñ–æ—Ä–º–∞—Ç—É +7 (XXX) XXX-XX-XX (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Å–∫—É –ø—Ä–∏ –Ω–µ–ø–æ–ª–Ω–æ–º –≤–≤–æ–¥–µ)
            formatAsRuPhone(rawDigits) {
                if (!rawDigits) return "+7 (___) ___-__-__";

                // 1) –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–≤—É—é —Ü–∏—Ñ—Ä—É –∫ '7'
                let d = this.onlyDigits(rawDigits);

                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª —Å 8 ‚Äî –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ 7
                if (d[0] === "8") d = "7" + d.slice(1);

                // –ï—Å–ª–∏ –Ω–∞—á–∞–ª —Å 9 (—á–∞—Å—Ç–æ —Ç–∞–∫ –≤–≤–æ–¥—è—Ç –º–æ–±–∏–ª—å–Ω—ã–µ) ‚Äî –¥–æ–±–∞–≤–∏–º –≤–µ–¥—É—â—É—é 7
                if (d[0] === "9") d = "7" + d;

                // –ï—Å–ª–∏ –Ω–∞—á–∞–ª –Ω–µ —Å 7 ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º 7 –≤–ø–µ—Ä–µ–¥–∏
                if (d[0] && d[0] !== "7") d = "7" + d.slice(1);

                // –û–≥—Ä–∞–Ω–∏—á–∏–º –º–∞–∫—Å–∏–º—É–º 11 —Ü–∏—Ñ—Ä–∞–º–∏ (7 + 10)
                d = d.slice(0, 11);

                // –û—Ç–¥–µ–ª–∏–º —á–∞—Å—Ç–∏
                const country = "+7";
                const rest = d[0] === "7" ? d.slice(1) : d; // –±–µ–∑ –≤–µ–¥—É—â–µ–π 7

                const a = rest.slice(0, 3);
                const b = rest.slice(3, 6);
                const c = rest.slice(6, 8);
                const e = rest.slice(8, 10);

                // –°—Ç—Ä–æ–∏–º —Å—Ç—Ä–æ–∫—É —Å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏
                const A = a.padEnd(3, "_");
                const B = b.padEnd(3, "_");
                const C = c.padEnd(2, "_");
                const E = e.padEnd(2, "_");

                return `${country} (${A}) ${B}-${C}-${E}`;
            }

            // –í–µ—Ä—Å–∏—è –±–µ–∑ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ ‚Äî –∏—Ç–æ–≥–æ–≤—ã–π ¬´—á–∏—Å—Ç—ã–π¬ª —Ñ–æ—Ä–º–∞—Ç
            formatAsRuPhoneTight(rawDigits) {
                let d = this.onlyDigits(rawDigits);
                if (d[0] === "8") d = "7" + d.slice(1);
                if (d[0] === "9") d = "7" + d;
                if (d[0] && d[0] !== "7") d = "7" + d.slice(1);
                d = d.slice(0, 11);

                const country = "+7";
                const rest = d[0] === "7" ? d.slice(1) : d;

                const a = rest.slice(0, 3);
                const b = rest.slice(3, 6);
                const c = rest.slice(6, 8);
                const e = rest.slice(8, 10);

                let out = `${country}`;
                if (a) out += ` (${a}`;
                if (a.length === 3) out += `)`;
                if (b) out += ` ${b}`;
                if (c) out += `-${c}`;
                if (e) out += `-${e}`;

                return out;
            }

            // –ü–æ–¥—Å—á—ë—Ç –ø–æ–∑–∏—Ü–∏–∏ –∫–∞—Ä–µ—Ç–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö —Ü–∏—Ñ—Ä
            getDigitsCountUpTo(text, caretIndex) {
                return this.onlyDigits(text.slice(0, caretIndex)).length;
            }

            caretFromDigitIndex(formattedText, digitIndex, skipInitialDigits = 0) {
                // –ü—Ä–æ–π–¥—ë–º –ø–æ —Å—Ç—Ä–æ–∫–µ –∏ –Ω–∞–π–¥—ë–º –ø–æ–∑–∏—Ü–∏—é, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç digitIndex —Ü–∏—Ñ—Ä,
                // –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø–µ—Ä–≤—ã–µ skipInitialDigits —Ü–∏—Ñ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ü–∏—Ñ—Ä—É –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã '+7')
                if (digitIndex <= 0) return 0;
                let count = 0;
                let skipped = 0;
                for (let i = 0; i < formattedText.length; i++) {
                    if (/\d/.test(formattedText[i])) {
                        if (skipped < skipInitialDigits) {
                            skipped++;
                            continue;
                        }
                        count++;
                        if (count === digitIndex) {
                            // –°—Ç–∞–≤–∏–º –∫–∞—Ä–µ—Ç–∫—É —Å—Ä–∞–∑—É –ü–û–°–õ–ï —ç—Ç–æ–π —Ü–∏—Ñ—Ä—ã
                            return i + 1;
                        }
                    }
                }
                return formattedText.length;
            }

            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            normalizePhone(phone) {
                if (!phone) return '';
                
                let d = this.onlyDigits(phone);
                if (d[0] === "8") d = "7" + d.slice(1);
                if (d[0] === "9") d = "7" + d;
                if (d[0] && d[0] !== "7") d = "7" + d.slice(1);
                d = d.slice(0, 11);
                
                return d.length === 11 ? '+7' + d.slice(1) : '';
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            validatePhone(phone) {
                const normalized = this.normalizePhone(phone);
                
                if (!normalized) {
                    return { valid: false, error: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω' };
                }
                
                if (normalized.length !== 12) {
                    return { valid: false, error: '–†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ +7' };
                }
                
                return { valid: true, normalized };
            }
        }

        // Initialize phone mask handler
        const phoneMaskHandler = new PhoneMaskHandler();
        const clearPhoneBtn = document.getElementById('clearPhoneBtn');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        phoneInput.value = "";
        phoneInput.placeholder = "+7 (___) ___-__-__";

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ª—é–±—ã–µ –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã (–∫—Ä–æ–º–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö –∫–ª–∞–≤–∏—à)
        phoneInput.addEventListener("keydown", (e) => {
            const allowed =
                e.ctrlKey || e.metaKey || e.altKey ||
                ["Backspace", "Delete", "ArrowLeft", "ArrowRight", "Home", "End", "Tab"].includes(e.key);

            if (allowed) return;

            if (!/\d/.test(e.key)) {
                e.preventDefault();
                return;
            }

            // –ï—Å–ª–∏ —É–∂–µ –≤–≤–µ–¥–µ–Ω–æ 11 —Ü–∏—Ñ—Ä ‚Äî –Ω–µ –¥–∞—ë–º –≤–≤–æ–¥–∏—Ç—å –±–æ–ª—å—à–µ
            const currentDigits = phoneMaskHandler.onlyDigits(phoneInput.value);
            if (currentDigits.length >= 11) {
                e.preventDefault();
            }
        });

        // –ñ–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ/–≤—Å—Ç–∞–≤–∫–µ
        const applyMask = () => {
            const prev = phoneInput.value;
            const start = phoneInput.selectionStart;
            const caretIndex = (start === null ? prev.length : start);

            let digitIndexBefore = phoneMaskHandler.getDigitsCountUpTo(prev, caretIndex);
            // Fallback –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤, –≥–¥–µ selectionStart –º–æ–∂–µ—Ç –±—ã—Ç—å 0 –ø—Ä–∏ –≤–≤–æ–¥–µ –ø–µ—Ä–≤–æ–π —Ü–∏—Ñ—Ä—ã
            const totalDigits = phoneMaskHandler.onlyDigits(prev).length;
            if (digitIndexBefore === 0 && totalDigits > 0) {
                digitIndexBefore = totalDigits;
            }
            const tight = phoneMaskHandler.formatAsRuPhoneTight(prev);
            const withMask = phoneMaskHandler.formatAsRuPhone(prev); // —Å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –ø–æ–∫–∞ –Ω–æ–º–µ—Ä –Ω–µ–ø–æ–ª–Ω—ã–π
            const rawDigits = phoneMaskHandler.onlyDigits(prev).slice(0, 11);
            const complete = rawDigits.length === 11;

            phoneInput.value = complete ? tight : withMask;

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –∫–∞—Ä–µ—Ç–∫—É –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ü–∏—Ñ—Ä,
            // –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∞–≤—Ç–æ-–ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã ('+7') –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è –≤–≤–µ–¥—ë–Ω–Ω–∞—è —Ü–∏—Ñ—Ä–∞ –Ω–µ '7'
            const prevDigits = phoneMaskHandler.onlyDigits(prev);
            const skipInitialDigits = (prevDigits && prevDigits.length > 0 && prevDigits[0] !== '7') ? 1 : 0;
            const newCaret = phoneMaskHandler.caretFromDigitIndex(phoneInput.value, digitIndexBefore, skipInitialDigits);
            phoneInput.setSelectionRange(newCaret, newCaret);
        };

        phoneInput.addEventListener("input", applyMask);
        phoneInput.addEventListener("paste", (e) => {
            e.preventDefault();
            const pasted = (e.clipboardData || window.clipboardData).getData("text");
            const digits = phoneMaskHandler.onlyDigits(pasted);
            // –í—Å—Ç–∞–≤–∏–º –æ—á–∏—â–µ–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –≤ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ
            const start = phoneInput.selectionStart || 0;
            const end = phoneInput.selectionEnd || 0;
            const before = phoneInput.value.slice(0, start);
            const after  = phoneInput.value.slice(end);
            phoneInput.value = before + digits + after;
            applyMask();
        });

        // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        clearPhoneBtn.addEventListener("click", () => {
            phoneInput.value = "";
            phoneInput.focus();
        });

        // –ù–∞ blur ‚Äî –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –ø–æ–ª–Ω—ã–π, –æ—Å—Ç–∞–≤–∏–º ¬´—á–∏—Å—Ç—ã–π¬ª —Ñ–æ—Ä–º–∞—Ç; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—á–∏—Å—Ç–∏–º
        phoneInput.addEventListener("blur", () => {
            const d = phoneMaskHandler.onlyDigits(phoneInput.value);
            if (d.length === 0) return;
            if (d.length < 11) {
                phoneInput.value = "";
            } else {
                phoneInput.value = phoneMaskHandler.formatAsRuPhoneTight(d);
            }
        });
        
        // Add real-time validation
        phoneInput.addEventListener('blur', (e) => {
            const validation = phoneMaskHandler.validatePhone(e.target.value);
            if (!validation.valid) {
                showStatus(validation.error, 'error');
                e.target.focus();
            }
        });
        
        // Show status message
        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `mt-6 p-4 rounded-2xl text-center animate-slideIn ${
                type === 'success' ? 'status-success' :
                type === 'error' ? 'status-error' :
                'status-info'
            }`;
            status.classList.remove('hidden');
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    status.classList.add('hidden');
                }, 5000);
            }
        }
        
        // Show QR code
        function showQRCode(qrCodeDataURL, authLink = '') {
            qrCode.innerHTML = `<img src="${qrCodeDataURL}" alt="QR Code" class="mx-auto max-w-full h-auto">`;
            currentAuthLink = authLink;
            qrModal.classList.remove('hidden');
        }
        
        // Show QR success with green checkmark
        function showQRSuccess() {
            qrCode.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mb-4 animate-bounce">
                        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-green-500 mb-2">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</h3>
                    <p class="text-gray-400 text-center">–ú–æ–¥–∞–ª –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...</p>
                </div>
            `;
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                qrModal.classList.add('hidden');
                // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                qrCode.innerHTML = '';
            }, 5000);
        }
        
        // Show auth link with smart device detection
        function showAuthLink(link) {
            authLink.textContent = link;
            linkModal.classList.remove('hidden');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            setTimeout(() => {
                openTelegramApp(link);
            }, 1000);
        }
        
        // Smart Telegram app opening
        function openTelegramApp(link) {
            const userAgent = navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(userAgent);
            const isAndroid = /android/.test(userAgent);
            const isMobile = /mobile|android|iphone|ipad/.test(userAgent);
            
            if (isMobile) {
                // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã
                if (isIOS) {
                    openTelegramIOS(link);
                } else if (isAndroid) {
                    openTelegramAndroid(link);
                } else {
                    // Fallback –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    window.open(link, '_blank');
                }
            } else {
                // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Å—Å—ã–ª–∫—É
                console.log('Desktop detected, showing link');
            }
        }
        
        // iOS Telegram opening with advanced detection
        function openTelegramIOS(link) {
            const tgScheme = link.replace('https://t.me/', 'tg://');
            let appOpened = false;
            
            // –ú–µ—Ç–æ–¥ 1: –ü—Ä—è–º–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ location.href
            try {
                window.location.href = tgScheme;
                appOpened = true;
            } catch (e) {
                console.log('Method 1 failed:', e);
            }
            
            // –ú–µ—Ç–æ–¥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏ –∏ –∫–ª–∏–∫
            if (!appOpened) {
                try {
                    const tempLink = document.createElement('a');
                    tempLink.href = tgScheme;
                    tempLink.style.display = 'none';
                    document.body.appendChild(tempLink);
                    tempLink.click();
                    document.body.removeChild(tempLink);
                    appOpened = true;
                } catch (e) {
                    console.log('Method 2 failed:', e);
                }
            }
            
            // –ú–µ—Ç–æ–¥ 3: Iframe fallback
            if (!appOpened) {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = tgScheme;
                document.body.appendChild(iframe);
                
                setTimeout(() => {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 1000);
            }
            
            // Fallback –Ω–∞ –≤–µ–±-–≤–µ—Ä—Å–∏—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (!appOpened) {
                    window.open(link, '_blank');
                }
            }, 3000);
        }
        
        // Android Telegram opening with multiple methods
        function openTelegramAndroid(link) {
            const botUsername = link.split('/').pop();
            let appOpened = false;
            
            // –ú–µ—Ç–æ–¥ 1: Intent URL —Å fallback
            const intentUrl = `intent://t.me/${botUsername}#Intent;scheme=https;package=org.telegram.messenger;S.browser_fallback_url=${encodeURIComponent(link)};end`;
            
            try {
                window.location.href = intentUrl;
                appOpened = true;
            } catch (e) {
                console.log('Intent method failed:', e);
            }
            
            // –ú–µ—Ç–æ–¥ 2: –ü—Ä—è–º–æ–π tg:// —Å—Ö–µ–º–∞
            if (!appOpened) {
                try {
                    const tgScheme = link.replace('https://t.me/', 'tg://');
                    window.location.href = tgScheme;
                    appOpened = true;
                } catch (e) {
                    console.log('TG scheme failed:', e);
                }
            }
            
            // –ú–µ—Ç–æ–¥ 3: Iframe —Å intent
            if (!appOpened) {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = intentUrl;
                document.body.appendChild(iframe);
                
                setTimeout(() => {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 1000);
            }
            
            // Fallback –Ω–∞ –≤–µ–±-–≤–µ—Ä—Å–∏—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (!appOpened) {
                    window.open(link, '_blank');
                }
            }, 3000);
        }
        
        // Show link success with green checkmark
        function showLinkSuccess() {
            const linkModalContent = linkModal.querySelector('.glass-card');
            linkModalContent.innerHTML = `
                <div class="text-center">
                    <div class="flex flex-col items-center justify-center py-8">
                        <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mb-4 animate-bounce">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-green-500 mb-2">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</h3>
                        <p class="text-gray-400 text-center">–ú–æ–¥–∞–ª –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...</p>
                    </div>
                </div>
            `;
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                linkModal.classList.add('hidden');
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                linkModalContent.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-white mb-4">üîó –°—Å—ã–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                        <div class="bg-slate-800/50 p-4 rounded-xl mb-4">
                            <p class="text-blue-400 break-all" id="authLink">https://t.me/bot?start=code</p>
                        </div>
                        <p class="text-gray-400 mb-4">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤ Telegram</p>
                        <div class="space-y-3">
                            <button id="openTelegramFromLinkBtn" class="btn-primary w-full px-6 py-3 rounded-xl text-white">
                                üöÄ –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                            </button>
                            <button id="copyLinkBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                            </button>
                            <button id="closeLinkBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>
                `;
                // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                setupLinkModalHandlers();
            }, 5000);
        }
        
        // Setup link modal handlers
        function setupLinkModalHandlers() {
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            const closeLinkBtn = document.getElementById('closeLinkBtn');
            const openTelegramFromLinkBtn = document.getElementById('openTelegramFromLinkBtn');
            
            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(authLink.textContent).then(() => {
                        showStatus('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
                    });
                });
            }
            
            if (closeLinkBtn) {
                closeLinkBtn.addEventListener('click', () => {
                    linkModal.classList.add('hidden');
                });
            }
            
            if (openTelegramFromLinkBtn) {
                openTelegramFromLinkBtn.addEventListener('click', () => {
                    window.open(authLink.textContent, '_blank');
                });
            }
        }
        
        // Copy to clipboard
        copyLinkBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(authLink.textContent).then(() => {
                showStatus('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
            });
        });
        
        // Close modals
        closeQrBtn.addEventListener('click', () => {
            qrModal.classList.add('hidden');
        });
        
        closeLinkBtn.addEventListener('click', () => {
            linkModal.classList.add('hidden');
        });
        
        // Open Telegram bot
        openTelegramBtn.addEventListener('click', () => {
            if (currentAuthLink) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
                window.open(currentAuthLink, '_blank');
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Å—ã–ª–∫–∏, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç–æ –±–æ—Ç–∞
                window.open('https://t.me/autor1z_bot', '_blank');
            }
        });
        
        // Open Telegram bot from link modal
        openTelegramFromLinkBtn.addEventListener('click', () => {
            const link = authLink.textContent;
            if (link && link !== 'https://t.me/bot?start=code') {
                window.open(link, '_blank');
            } else {
                window.open('https://t.me/autor1z_bot', '_blank');
            }
        });
        
        // Request authorization with improved validation
        requestAuthBtn.addEventListener('click', () => {
            const validation = phoneMaskHandler.validatePhone(phoneInput.value);
            
            if (!validation.valid) {
                showStatus(validation.error, 'error');
                phoneInput.focus();
                return;
            }
            
            socket.emit('requestAuth', { phone: validation.normalized });
            showStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...', 'info');
        });
        
        // Verify code with improved validation
        verifyCodeBtn.addEventListener('click', () => {
            const validation = phoneMaskHandler.validatePhone(phoneInput.value);
            const code = codeInput.value.trim();
            
            if (!validation.valid) {
                showStatus(validation.error, 'error');
                phoneInput.focus();
                return;
            }
            
            if (!code) {
                showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥', 'error');
                codeInput.focus();
                return;
            }
            
            if (code.length < 4) {
                showStatus('–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã', 'error');
                codeInput.focus();
                return;
            }
            
            socket.emit('verifyCode', { phone: validation.normalized, code });
            showStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...', 'info');
        });
        
        // Back button
        backBtn.addEventListener('click', () => {
            authForm.classList.remove('hidden');
            codeForm.classList.add('hidden');
            userInfo.classList.add('hidden');
            phoneInput.value = '';
            codeInput.value = '';
        });
        
        // Logout
        logoutBtn.addEventListener('click', () => {
            socket.emit('logout');
        });
        
        // Socket events
        socket.on('connect', () => {
            console.log('Connected to server');
        });
        
        socket.on('authKey', (data) => {
            showStatus('–ö–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω!', 'success');
            
            if (data.qrCode) {
                showQRCode(data.qrCode, data.link);
            } else if (data.link) {
                showAuthLink(data.link);
            }
        });
        
        socket.on('smsCodeSent', (data) => {
            showStatus(`–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –Ω–∞ –Ω–æ–º–µ—Ä ${data.phone}. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ:`, 'info');
            authForm.classList.add('hidden');
            codeForm.classList.remove('hidden');
        });
        
        socket.on('authSuccess', (data) => {
            showStatus('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
            document.getElementById('userName').textContent = data.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userPhone').textContent = data.phone;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            authForm.classList.add('hidden');
            codeForm.classList.add('hidden');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            userInfo.classList.remove('hidden');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º sessionToken –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
            if (data.sessionToken) {
                localStorage.setItem('sessionToken', data.sessionToken);
            }
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç QR-–º–æ–¥–∞–ª –∏–ª–∏ –º–æ–¥–∞–ª —Å —Å—Å—ã–ª–∫–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–µ–ª–µ–Ω—É—é –≥–∞–ª–æ—á–∫—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            if (!qrModal.classList.contains('hidden')) {
                showQRSuccess();
            } else if (!linkModal.classList.contains('hidden')) {
                showLinkSuccess();
            }
        });
        
        socket.on('authError', (data) => {
            showStatus(data.message, 'error');
        });
        
        socket.on('serverShutdown', (data) => {
            showStatus('–°–µ—Ä–≤–µ—Ä –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...', 'warning');
            setTimeout(() => {
                location.reload();
            }, 3000);
        });
        
        socket.on('logoutSuccess', () => {
            showStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
            userInfo.classList.add('hidden');
            authForm.classList.remove('hidden');
            phoneInput.value = '';
            codeInput.value = '';
            
            // –û—á–∏—â–∞–µ–º sessionToken –∏–∑ localStorage
            localStorage.removeItem('sessionToken');
        });
        
        socket.on('sessionReset', () => {
            showStatus('–°–µ—Å—Å–∏—è —Å–±—Ä–æ—à–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.', 'info');
            userInfo.classList.add('hidden');
            codeForm.classList.remove('hidden');
        });
        
        socket.on('alreadyAuthorized', (data) => {
            document.getElementById('userName').textContent = data.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userPhone').textContent = data.phone;
            authForm.classList.add('hidden');
            userInfo.classList.remove('hidden');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º sessionToken –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
            if (data.sessionToken) {
                localStorage.setItem('sessionToken', data.sessionToken);
            }
        });
        
        // Check existing authorization on load
        window.addEventListener('load', () => {
            const sessionToken = localStorage.getItem('sessionToken');
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', { sessionToken });
            if (sessionToken) {
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º checkAuth —Å sessionToken:', sessionToken);
                socket.emit('checkAuth', { sessionToken });
            } else {
                console.log('sessionToken –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage');
            }
            
            // Register Service Worker for PWA
            registerServiceWorker();
        });
        
        // Register Service Worker for PWA
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            }
        }
    </script>
</body>
</html>