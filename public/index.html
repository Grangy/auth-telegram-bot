<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Authorization</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0088cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Telegram Auth">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1e1b4b 50%, var(--bg-primary) 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .phone-input {
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid rgba(148, 163, 184, 0.3);
            transition: all 0.3s ease;
        }
        
        .phone-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(30, 41, 59, 0.8);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
            border-color: rgba(148, 163, 184, 0.5);
        }
        
        .status-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .status-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        
        .status-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-slideIn {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="glass-card rounded-3xl p-8 w-full max-w-md mx-auto animate-fadeIn">
        <!-- Logo -->
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">üîê</div>
            <h1 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                Telegram Authorization
            </h1>
            <p class="text-gray-400">–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</p>
        </div>
        
        <!-- Auth Form -->
        <div id="authForm" class="space-y-6">
            <div>
                <label class="block text-lg font-semibold text-white mb-4">üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                
                <!-- –ö—Ä–∞—Å–∏–≤—ã–π input –¥–ª—è –Ω–æ–º–µ—Ä–∞ -->
                <div class="relative">
                    <input 
                        type="tel" 
                        id="phoneInput" 
                        placeholder="+7 (999) 123-45-67"
                        class="phone-input w-full px-6 py-4 text-lg rounded-2xl text-white placeholder-gray-400 focus:outline-none"
                        maxlength="20"
                        autocomplete="tel"
                        inputmode="tel"
                    >
                    <div class="absolute inset-y-0 right-0 flex items-center pr-4">
                        <span class="text-gray-400 text-sm">üì±</span>
                    </div>
                </div>
                
                <p class="text-xs text-gray-400 mt-2">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: +7 (999) 123-45-67, 8 999 123 45 67, 79991234567
                </p>
            </div>
            
            <button 
                id="requestAuthBtn" 
                class="btn-primary w-full py-4 px-6 rounded-2xl text-white font-semibold text-lg"
            >
                üöÄ –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
            </button>
        </div>
        
        <!-- Code Form -->
        <div id="codeForm" class="space-y-6 hidden">
            <div>
                <label class="block text-lg font-semibold text-white mb-4">üî¢ –ö–æ–¥ –∏–∑ Telegram</label>
                <input 
                    type="text" 
                    id="codeInput" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥"
                    class="phone-input w-full px-6 py-4 text-lg rounded-2xl text-white placeholder-gray-400 focus:outline-none text-center"
                    maxlength="6"
                >
            </div>
            
            <button 
                id="verifyCodeBtn" 
                class="btn-primary w-full py-4 px-6 rounded-2xl text-white font-semibold text-lg"
            >
                ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥
            </button>
            
            <button 
                id="backBtn" 
                class="btn-secondary w-full py-3 px-6 rounded-2xl text-white font-medium"
            >
                ‚Üê –ù–∞–∑–∞–¥
            </button>
        </div>
        
        <!-- User Info -->
        <div id="userInfo" class="space-y-6 hidden">
            <div class="text-center">
                <div class="text-4xl mb-4">üë§</div>
                <h2 class="text-2xl font-bold text-white mb-2" id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                <p class="text-gray-400" id="userPhone">+7 999 123 45 67</p>
            </div>
            
            <button 
                id="logoutBtn" 
                class="btn-secondary w-full py-3 px-6 rounded-2xl text-white font-medium"
            >
                üö™ –í—ã–π—Ç–∏
            </button>
        </div>
        
        <!-- Status -->
        <div id="status" class="mt-6 p-4 rounded-2xl text-center hidden"></div>
    </div>
    
    <!-- QR Code Modal -->
    <div id="qrModal" class="fixed inset-0 modal flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-3xl p-8 max-w-md mx-auto">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-white mb-4">üì± QR-–∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                <div id="qrCode" class="mb-4"></div>
                <p class="text-gray-400 mb-4">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ Telegram</p>
                <div class="space-y-3">
                    <button id="openTelegramBtn" class="btn-primary w-full px-6 py-3 rounded-xl text-white">
                        üöÄ –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                    </button>
                    <button id="closeQrBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auth Link Modal -->
    <div id="linkModal" class="fixed inset-0 modal flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-3xl p-8 max-w-md mx-auto">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-white mb-4">üîó –°—Å—ã–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                <div class="bg-slate-800/50 p-4 rounded-xl mb-4">
                    <p class="text-blue-400 break-all" id="authLink">https://t.me/bot?start=code</p>
                </div>
                <p class="text-gray-400 mb-4">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤ Telegram</p>
                <div class="space-y-3">
                    <button id="openTelegramFromLinkBtn" class="btn-primary w-full px-6 py-3 rounded-xl text-white">
                        üöÄ –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                    </button>
                    <button id="copyLinkBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                    </button>
                    <button id="closeLinkBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        
        // DOM elements
        const authForm = document.getElementById('authForm');
        const codeForm = document.getElementById('codeForm');
        const userInfo = document.getElementById('userInfo');
        const phoneInput = document.getElementById('phoneInput');
        const codeInput = document.getElementById('codeInput');
        const requestAuthBtn = document.getElementById('requestAuthBtn');
        const verifyCodeBtn = document.getElementById('verifyCodeBtn');
        const backBtn = document.getElementById('backBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const status = document.getElementById('status');
        const qrModal = document.getElementById('qrModal');
        const linkModal = document.getElementById('linkModal');
        const qrCode = document.getElementById('qrCode');
        const authLink = document.getElementById('authLink');
        const closeQrBtn = document.getElementById('closeQrBtn');
        const closeLinkBtn = document.getElementById('closeLinkBtn');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const openTelegramBtn = document.getElementById('openTelegramBtn');
        const openTelegramFromLinkBtn = document.getElementById('openTelegramFromLinkBtn');
        
        // Store current auth link
        let currentAuthLink = '';
        
        // Advanced phone number formatting and validation
        class PhoneHandler {
            constructor() {
                this.phonePatterns = {
                    russia: /^(\+7|7|8)?[\s\-]?\(?(\d{3})\)?[\s\-]?(\d{3})[\s\-]?(\d{2})[\s\-]?(\d{2})$/,
                    international: /^\+?[1-9]\d{1,14}$/
                };
            }

            // Normalize phone number to international format
            normalizePhone(phone) {
                if (!phone) return '';
                
                // Remove all non-digits except +
                let cleaned = phone.replace(/[^\d+]/g, '');
                
                // Handle Russian numbers - –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                if (cleaned.startsWith('8')) {
                    // 8XXXXXXXXXX -> +7XXXXXXXXXX
                    cleaned = '+7' + cleaned.substring(1);
                } else if (cleaned.startsWith('7') && !cleaned.startsWith('+7')) {
                    // 7XXXXXXXXXX -> +7XXXXXXXXXX
                    cleaned = '+' + cleaned;
                } else if (cleaned.startsWith('+7')) {
                    // +7XXXXXXXXXX -> –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
                    cleaned = cleaned;
                } else if (cleaned.startsWith('9') && cleaned.length >= 10) {
                    // 9XXXXXXXXX -> +79XXXXXXXXX (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã)
                    cleaned = '+7' + cleaned;
                } else if (cleaned.startsWith('978') && cleaned.length >= 10) {
                    // 978XXXXXXXX -> +7978XXXXXXXX (—É–∂–µ –µ—Å—Ç—å –∫–æ–¥ 7, –¥–æ–±–∞–≤–ª—è–µ–º +)
                    cleaned = '+' + cleaned;
                } else if (cleaned.length > 0 && !cleaned.startsWith('+')) {
                    // –õ—é–±–æ–π –¥—Ä—É–≥–æ–π –Ω–æ–º–µ—Ä -> –¥–æ–±–∞–≤–ª—è–µ–º +
                    cleaned = '+' + cleaned;
                }
                
                return cleaned;
            }

            // Format phone for display
            formatPhoneDisplay(phone) {
                const normalized = this.normalizePhone(phone);
                
                if (!normalized) return '';
                
                // Russian format: +7 (XXX) XXX-XX-XX
                if (normalized.startsWith('+7') && normalized.length === 12) {
                    const digits = normalized.substring(2);
                    return `+7 (${digits.substring(0, 3)}) ${digits.substring(3, 6)}-${digits.substring(6, 8)}-${digits.substring(8, 10)}`;
                }
                
                // International format: +XX XXX XXX XXXX
                if (normalized.startsWith('+') && normalized.length >= 8) {
                    const countryCode = normalized.substring(1, 3);
                    const number = normalized.substring(3);
                    
                    if (number.length <= 3) {
                        return `+${countryCode} ${number}`;
                    } else if (number.length <= 6) {
                        return `+${countryCode} ${number.substring(0, 3)} ${number.substring(3)}`;
                    } else {
                        return `+${countryCode} ${number.substring(0, 3)} ${number.substring(3, 6)} ${number.substring(6)}`;
                    }
                }
                
                return normalized;
            }

            // Validate phone number
            validatePhone(phone) {
                const normalized = this.normalizePhone(phone);
                
                if (!normalized) {
                    return { valid: false, error: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω' };
                }
                
                if (normalized.length < 8) {
                    return { valid: false, error: '–ù–æ–º–µ—Ä —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π' };
                }
                
                if (normalized.length > 16) {
                    return { valid: false, error: '–ù–æ–º–µ—Ä —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π' };
                }
                
                if (!normalized.startsWith('+')) {
                    return { valid: false, error: '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å +' };
                }
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤
                if (normalized.startsWith('+7')) {
                    // –†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å +7XXXXXXXXXX (12 —Å–∏–º–≤–æ–ª–æ–≤)
                    if (normalized.length !== 12) {
                        return { valid: false, error: '–†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ +7' };
                    }
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ +7 –∏–¥–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π –∫–æ–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                    const operatorCode = normalized.substring(2, 5);
                    if (!['900', '901', '902', '903', '904', '905', '906', '908', '909', '910', '911', '912', '913', '914', '915', '916', '917', '918', '919', '920', '921', '922', '923', '924', '925', '926', '927', '928', '929', '930', '931', '932', '933', '934', '935', '936', '937', '938', '939', '950', '951', '952', '953', '954', '955', '956', '957', '958', '959', '960', '961', '962', '963', '964', '965', '966', '967', '968', '969', '970', '971', '972', '973', '974', '975', '976', '977', '978', '979', '980', '981', '982', '983', '984', '985', '986', '987', '988', '989', '991', '992', '993', '994', '995', '996', '997', '998', '999'].includes(operatorCode)) {
                        return { valid: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞' };
                    }
                }
                
                // Check for valid country code
                const countryCode = normalized.substring(1, 3);
                if (countryCode.length < 1 || countryCode.length > 3) {
                    return { valid: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã' };
                }
                
                return { valid: true, normalized };
            }

            // Format phone as user types with live normalization
            formatPhoneInput(value) {
                if (!value) return '';
                
                // Remove all non-digits except +
                let cleaned = value.replace(/[^\d+]/g, '');
                
                // Handle backspace - don't add formatting if user is deleting
                if (cleaned.length < this.lastLength) {
                    this.lastLength = cleaned.length;
                    return cleaned;
                }
                
                this.lastLength = cleaned.length;
                
                // Live normalization after 4 characters
                if (cleaned.length >= 4) {
                    cleaned = this.liveNormalizePhone(cleaned);
                }
                
                // Format for display
                return this.formatPhoneDisplay(cleaned);
            }
            
            // Live phone normalization after 4 characters
            liveNormalizePhone(phone) {
                if (!phone) return '';
                
                // Remove all non-digits except +
                let cleaned = phone.replace(/[^\d+]/g, '');
                
                // Live normalization logic with smart detection
                if (cleaned.startsWith('8') && cleaned.length >= 4) {
                    // 8XXXXXXXXXX -> +7XXXXXXXXXX
                    cleaned = '+7' + cleaned.substring(1);
                } else if (cleaned.startsWith('7') && !cleaned.startsWith('+7') && cleaned.length >= 4) {
                    // 7XXXXXXXXXX -> +7XXXXXXXXXX
                    cleaned = '+' + cleaned;
                } else if (cleaned.startsWith('9') && cleaned.length >= 4) {
                    // 9XXXXXXXXX -> +79XXXXXXXXX (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã)
                    cleaned = '+7' + cleaned;
                } else if (cleaned.startsWith('978') && cleaned.length >= 4) {
                    // 978XXXXXXXX -> +7978XXXXXXXX (—É–∂–µ –µ—Å—Ç—å –∫–æ–¥ 7, –¥–æ–±–∞–≤–ª—è–µ–º +)
                    cleaned = '+' + cleaned;
                } else if (cleaned.startsWith('97') && cleaned.length >= 4) {
                    // 97XXXXXXXX -> +797XXXXXXXX (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã)
                    cleaned = '+7' + cleaned;
                } else if (cleaned.length >= 4 && !cleaned.startsWith('+')) {
                    // –õ—é–±–æ–π –¥—Ä—É–≥–æ–π –Ω–æ–º–µ—Ä -> –¥–æ–±–∞–≤–ª—è–µ–º +
                    cleaned = '+' + cleaned;
                }
                
                return cleaned;
            }
        }

        // Initialize phone handler
        const phoneHandler = new PhoneHandler();
        
        // Format phone input with advanced handler and live normalization
        phoneInput.addEventListener('input', (e) => {
            const originalValue = e.target.value;
            const formatted = phoneHandler.formatPhoneInput(originalValue);
            
            // Check if normalization occurred
            if (formatted !== originalValue && formatted.length >= 4) {
                // Show normalization indicator
                showNormalizationIndicator(originalValue, formatted);
            }
            
            e.target.value = formatted;
        });
        
        // Show normalization indicator with smart messaging
        function showNormalizationIndicator(original, normalized) {
            // Determine normalization type
            let message = '‚úì –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ';
            let bgColor = 'bg-green-500';
            
            if (original.startsWith('8') && normalized.startsWith('+7')) {
                message = '‚úì 8 ‚Üí +7';
                bgColor = 'bg-blue-500';
            } else if (original.startsWith('7') && normalized.startsWith('+7')) {
                message = '‚úì +7 –¥–æ–±–∞–≤–ª–µ–Ω';
                bgColor = 'bg-blue-500';
            } else if (original.startsWith('9') && normalized.startsWith('+7')) {
                message = '‚úì +7 –¥–æ–±–∞–≤–ª–µ–Ω';
                bgColor = 'bg-blue-500';
            } else if (original.startsWith('97') && normalized.startsWith('+7')) {
                message = '‚úì +7 –¥–æ–±–∞–≤–ª–µ–Ω';
                bgColor = 'bg-blue-500';
            }
            
            // Create temporary indicator
            const indicator = document.createElement('div');
            indicator.className = `absolute top-0 right-0 ${bgColor} text-white text-xs px-2 py-1 rounded-bl-lg opacity-0 transition-all duration-300 transform scale-95`;
            indicator.textContent = message;
            
            // Add to phone input container
            const phoneContainer = phoneInput.parentElement;
            phoneContainer.style.position = 'relative';
            phoneContainer.appendChild(indicator);
            
            // Show indicator with animation
            setTimeout(() => {
                indicator.style.opacity = '1';
                indicator.style.transform = 'scale(1)';
            }, 100);
            
            // Hide indicator after 2.5 seconds
            setTimeout(() => {
                indicator.style.opacity = '0';
                indicator.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    if (phoneContainer.contains(indicator)) {
                        phoneContainer.removeChild(indicator);
                    }
                }, 300);
            }, 2500);
        }

        // Add real-time validation
        phoneInput.addEventListener('blur', (e) => {
            const validation = phoneHandler.validatePhone(e.target.value);
            if (!validation.valid) {
                showStatus(validation.error, 'error');
                e.target.focus();
            }
        });
        
        // Show status message
        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `mt-6 p-4 rounded-2xl text-center animate-slideIn ${
                type === 'success' ? 'status-success' :
                type === 'error' ? 'status-error' :
                'status-info'
            }`;
            status.classList.remove('hidden');
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    status.classList.add('hidden');
                }, 5000);
            }
        }
        
        // Show QR code
        function showQRCode(qrCodeDataURL, authLink = '') {
            qrCode.innerHTML = `<img src="${qrCodeDataURL}" alt="QR Code" class="mx-auto max-w-full h-auto">`;
            currentAuthLink = authLink;
            qrModal.classList.remove('hidden');
        }
        
        // Show QR success with green checkmark
        function showQRSuccess() {
            qrCode.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mb-4 animate-bounce">
                        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-green-500 mb-2">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</h3>
                    <p class="text-gray-400 text-center">–ú–æ–¥–∞–ª –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...</p>
                </div>
            `;
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                qrModal.classList.add('hidden');
                // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                qrCode.innerHTML = '';
            }, 5000);
        }
        
        // Show auth link with smart device detection
        function showAuthLink(link) {
            authLink.textContent = link;
            linkModal.classList.remove('hidden');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            setTimeout(() => {
                openTelegramApp(link);
            }, 1000);
        }
        
        // Smart Telegram app opening
        function openTelegramApp(link) {
            const userAgent = navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(userAgent);
            const isAndroid = /android/.test(userAgent);
            const isMobile = /mobile|android|iphone|ipad/.test(userAgent);
            
            if (isMobile) {
                // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã
                if (isIOS) {
                    openTelegramIOS(link);
                } else if (isAndroid) {
                    openTelegramAndroid(link);
                } else {
                    // Fallback –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    window.open(link, '_blank');
                }
            } else {
                // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Å—Å—ã–ª–∫—É
                console.log('Desktop detected, showing link');
            }
        }
        
        // iOS Telegram opening with advanced detection
        function openTelegramIOS(link) {
            const tgScheme = link.replace('https://t.me/', 'tg://');
            let appOpened = false;
            
            // –ú–µ—Ç–æ–¥ 1: –ü—Ä—è–º–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ location.href
            try {
                window.location.href = tgScheme;
                appOpened = true;
            } catch (e) {
                console.log('Method 1 failed:', e);
            }
            
            // –ú–µ—Ç–æ–¥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏ –∏ –∫–ª–∏–∫
            if (!appOpened) {
                try {
                    const tempLink = document.createElement('a');
                    tempLink.href = tgScheme;
                    tempLink.style.display = 'none';
                    document.body.appendChild(tempLink);
                    tempLink.click();
                    document.body.removeChild(tempLink);
                    appOpened = true;
                } catch (e) {
                    console.log('Method 2 failed:', e);
                }
            }
            
            // –ú–µ—Ç–æ–¥ 3: Iframe fallback
            if (!appOpened) {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = tgScheme;
                document.body.appendChild(iframe);
                
                setTimeout(() => {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 1000);
            }
            
            // Fallback –Ω–∞ –≤–µ–±-–≤–µ—Ä—Å–∏—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (!appOpened) {
                    window.open(link, '_blank');
                }
            }, 3000);
        }
        
        // Android Telegram opening with multiple methods
        function openTelegramAndroid(link) {
            const botUsername = link.split('/').pop();
            let appOpened = false;
            
            // –ú–µ—Ç–æ–¥ 1: Intent URL —Å fallback
            const intentUrl = `intent://t.me/${botUsername}#Intent;scheme=https;package=org.telegram.messenger;S.browser_fallback_url=${encodeURIComponent(link)};end`;
            
            try {
                window.location.href = intentUrl;
                appOpened = true;
            } catch (e) {
                console.log('Intent method failed:', e);
            }
            
            // –ú–µ—Ç–æ–¥ 2: –ü—Ä—è–º–æ–π tg:// —Å—Ö–µ–º–∞
            if (!appOpened) {
                try {
                    const tgScheme = link.replace('https://t.me/', 'tg://');
                    window.location.href = tgScheme;
                    appOpened = true;
                } catch (e) {
                    console.log('TG scheme failed:', e);
                }
            }
            
            // –ú–µ—Ç–æ–¥ 3: Iframe —Å intent
            if (!appOpened) {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = intentUrl;
                document.body.appendChild(iframe);
                
                setTimeout(() => {
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 1000);
            }
            
            // Fallback –Ω–∞ –≤–µ–±-–≤–µ—Ä—Å–∏—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (!appOpened) {
                    window.open(link, '_blank');
                }
            }, 3000);
        }
        
        // Show link success with green checkmark
        function showLinkSuccess() {
            const linkModalContent = linkModal.querySelector('.glass-card');
            linkModalContent.innerHTML = `
                <div class="text-center">
                    <div class="flex flex-col items-center justify-center py-8">
                        <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mb-4 animate-bounce">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-green-500 mb-2">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</h3>
                        <p class="text-gray-400 text-center">–ú–æ–¥–∞–ª –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...</p>
                    </div>
                </div>
            `;
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                linkModal.classList.add('hidden');
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                linkModalContent.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-white mb-4">üîó –°—Å—ã–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                        <div class="bg-slate-800/50 p-4 rounded-xl mb-4">
                            <p class="text-blue-400 break-all" id="authLink">https://t.me/bot?start=code</p>
                        </div>
                        <p class="text-gray-400 mb-4">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤ Telegram</p>
                        <div class="space-y-3">
                            <button id="openTelegramFromLinkBtn" class="btn-primary w-full px-6 py-3 rounded-xl text-white">
                                üöÄ –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                            </button>
                            <button id="copyLinkBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                            </button>
                            <button id="closeLinkBtn" class="btn-secondary w-full px-6 py-3 rounded-xl text-white">
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>
                `;
                // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                setupLinkModalHandlers();
            }, 5000);
        }
        
        // Setup link modal handlers
        function setupLinkModalHandlers() {
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            const closeLinkBtn = document.getElementById('closeLinkBtn');
            const openTelegramFromLinkBtn = document.getElementById('openTelegramFromLinkBtn');
            
            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(authLink.textContent).then(() => {
                        showStatus('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
                    });
                });
            }
            
            if (closeLinkBtn) {
                closeLinkBtn.addEventListener('click', () => {
                    linkModal.classList.add('hidden');
                });
            }
            
            if (openTelegramFromLinkBtn) {
                openTelegramFromLinkBtn.addEventListener('click', () => {
                    window.open(authLink.textContent, '_blank');
                });
            }
        }
        
        // Copy to clipboard
        copyLinkBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(authLink.textContent).then(() => {
                showStatus('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
            });
        });
        
        // Close modals
        closeQrBtn.addEventListener('click', () => {
            qrModal.classList.add('hidden');
        });
        
        closeLinkBtn.addEventListener('click', () => {
            linkModal.classList.add('hidden');
        });
        
        // Open Telegram bot
        openTelegramBtn.addEventListener('click', () => {
            if (currentAuthLink) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
                window.open(currentAuthLink, '_blank');
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Å—ã–ª–∫–∏, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç–æ –±–æ—Ç–∞
                window.open('https://t.me/autor1z_bot', '_blank');
            }
        });
        
        // Open Telegram bot from link modal
        openTelegramFromLinkBtn.addEventListener('click', () => {
            const link = authLink.textContent;
            if (link && link !== 'https://t.me/bot?start=code') {
                window.open(link, '_blank');
            } else {
                window.open('https://t.me/autor1z_bot', '_blank');
            }
        });
        
        // Request authorization with improved validation
        requestAuthBtn.addEventListener('click', () => {
            const validation = phoneHandler.validatePhone(phoneInput.value);
            
            if (!validation.valid) {
                showStatus(validation.error, 'error');
                phoneInput.focus();
                return;
            }
            
            socket.emit('requestAuth', { phone: validation.normalized });
            showStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...', 'info');
        });
        
        // Verify code with improved validation
        verifyCodeBtn.addEventListener('click', () => {
            const validation = phoneHandler.validatePhone(phoneInput.value);
            const code = codeInput.value.trim();
            
            if (!validation.valid) {
                showStatus(validation.error, 'error');
                phoneInput.focus();
                return;
            }
            
            if (!code) {
                showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥', 'error');
                codeInput.focus();
                return;
            }
            
            if (code.length < 4) {
                showStatus('–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 4 —Ü–∏—Ñ—Ä—ã', 'error');
                codeInput.focus();
                return;
            }
            
            socket.emit('verifyCode', { phone: validation.normalized, code });
            showStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...', 'info');
        });
        
        // Back button
        backBtn.addEventListener('click', () => {
            authForm.classList.remove('hidden');
            codeForm.classList.add('hidden');
            userInfo.classList.add('hidden');
            phoneInput.value = '';
            codeInput.value = '';
        });
        
        // Logout
        logoutBtn.addEventListener('click', () => {
            socket.emit('logout');
        });
        
        // Socket events
        socket.on('connect', () => {
            console.log('Connected to server');
        });
        
        socket.on('authKey', (data) => {
            showStatus('–ö–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω!', 'success');
            
            if (data.qrCode) {
                showQRCode(data.qrCode, data.link);
            } else if (data.link) {
                showAuthLink(data.link);
            }
        });
        
        socket.on('smsCodeSent', (data) => {
            showStatus(`–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –Ω–∞ –Ω–æ–º–µ—Ä ${data.phone}. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ:`, 'info');
            authForm.classList.add('hidden');
            codeForm.classList.remove('hidden');
        });
        
        socket.on('authSuccess', (data) => {
            showStatus('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
            document.getElementById('userName').textContent = data.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userPhone').textContent = data.phone;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            authForm.classList.add('hidden');
            codeForm.classList.add('hidden');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            userInfo.classList.remove('hidden');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º sessionToken –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
            if (data.sessionToken) {
                localStorage.setItem('sessionToken', data.sessionToken);
            }
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç QR-–º–æ–¥–∞–ª –∏–ª–∏ –º–æ–¥–∞–ª —Å —Å—Å—ã–ª–∫–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–µ–ª–µ–Ω—É—é –≥–∞–ª–æ—á–∫—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            if (!qrModal.classList.contains('hidden')) {
                showQRSuccess();
            } else if (!linkModal.classList.contains('hidden')) {
                showLinkSuccess();
            }
        });
        
        socket.on('authError', (data) => {
            showStatus(data.message, 'error');
        });
        
        socket.on('logoutSuccess', () => {
            showStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
            userInfo.classList.add('hidden');
            authForm.classList.remove('hidden');
            phoneInput.value = '';
            codeInput.value = '';
            
            // –û—á–∏—â–∞–µ–º sessionToken –∏–∑ localStorage
            localStorage.removeItem('sessionToken');
        });
        
        socket.on('sessionReset', () => {
            showStatus('–°–µ—Å—Å–∏—è —Å–±—Ä–æ—à–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.', 'info');
            userInfo.classList.add('hidden');
            codeForm.classList.remove('hidden');
        });
        
        socket.on('alreadyAuthorized', (data) => {
            document.getElementById('userName').textContent = data.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userPhone').textContent = data.phone;
            authForm.classList.add('hidden');
            userInfo.classList.remove('hidden');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º sessionToken –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
            if (data.sessionToken) {
                localStorage.setItem('sessionToken', data.sessionToken);
            }
        });
        
        // Check existing authorization on load
        window.addEventListener('load', () => {
            const sessionToken = localStorage.getItem('sessionToken');
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', { sessionToken });
            if (sessionToken) {
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º checkAuth —Å sessionToken:', sessionToken);
                socket.emit('checkAuth', { sessionToken });
            } else {
                console.log('sessionToken –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage');
            }
            
            // Register Service Worker for PWA
            registerServiceWorker();
        });
        
        // Register Service Worker for PWA
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            }
        }
    </script>
</body>
</html>